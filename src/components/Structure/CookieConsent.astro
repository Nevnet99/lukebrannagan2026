---
import { Cookie, Check, X } from "@lucide/astro";
---

{/* 1. THE BLUR BACKDROP */}
<div
  id="cookie-backdrop"
  class="fixed inset-0 z-[90] bg-background/50 backdrop-blur-sm opacity-0 invisible transition-opacity duration-500 ease-out"
>
</div>

{/* 2. THE BOTTOM BANNER */}
<div
  id="cookie-banner"
  class="fixed bottom-0 left-0 right-0 z-[100] border-t border-text/10 bg-[#0d1117]/95 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] translate-y-[100%] transition-transform duration-500 ease-out font-mono"
  role="alert"
>
  <div
    class="max-w-7xl mx-auto flex flex-col md:flex-row items-start md:items-center justify-between gap-6 p-6"
  >
    {/* LEFT: FRIENDLY TEXT */}
    <div class="flex items-start gap-4 max-w-2xl">
      <div class="p-3 bg-text/5 rounded-sm border border-text/10 shrink-0">
        <Cookie class="text-text/60" size={24} />
      </div>
      <div>
        <h3 class="text-sm font-bold text-text uppercase tracking-widest mb-1">
          Cookie Preferences
        </h3>
        <p class="text-xs text-text/60 leading-relaxed">
          I use anonymous analytics (PostHog) to understand which projects are
          being viewed. No personal data is collected. <strong
            >You have the right to decline the use of tracking cookies.</strong
          >
        </p>
      </div>
    </div>

    {/* RIGHT: STANDARD BUTTONS */}
    <div class="flex items-center gap-3 w-full md:w-auto">
      {/* DECLINE */}
      <button
        id="cookie-deny"
        class="flex-1 md:flex-none group flex items-center justify-center gap-2 bg-transparent border border-text/10 hover:border-text/50 text-text/60 hover:text-text py-3 px-6 text-xs font-bold uppercase transition-all whitespace-nowrap"
      >
        <X size={14} />
        <span>Decline</span>
      </button>

      {/* ACCEPT */}
      <button
        id="cookie-accept"
        class="flex-1 md:flex-none group flex items-center justify-center gap-2 bg-text/10 hover:bg-text/20 border border-text/20 hover:border-text/60 text-text py-3 px-8 text-xs font-bold uppercase transition-all whitespace-nowrap"
      >
        <Check size={14} />
        <span>Accept</span>
      </button>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    const backdrop = document.getElementById("cookie-backdrop");
    const banner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("cookie-accept");
    const denyBtn = document.getElementById("cookie-deny");

    // --- UI HELPERS ---
    const showConsent = () => {
      backdrop.classList.remove("opacity-0", "invisible");
      banner.classList.remove("translate-y-[100%]");
      document.body.style.overflow = "hidden"; // Lock scroll
    };

    const hideConsent = () => {
      backdrop.classList.add("opacity-0");
      banner.classList.add("translate-y-[100%]");
      document.body.style.overflow = ""; // Unlock scroll

      setTimeout(() => {
        backdrop.classList.add("invisible");
      }, 500);
    };

    // --- INIT CHECK ---
    const consent = localStorage.getItem("cookie_consent");

    if (!consent) {
      setTimeout(showConsent, 500);
    }

    // --- HANDLERS ---
    acceptBtn?.addEventListener("click", () => {
      localStorage.setItem("cookie_consent", "granted");
      hideConsent();

      // Enable Analytics
      if (window.posthog) {
        window.posthog.opt_in_capturing();
        window.posthog.capture("$pageview");
      }
    });

    denyBtn?.addEventListener("click", () => {
      localStorage.setItem("cookie_consent", "denied");
      hideConsent();

      // Disable Analytics
      if (window.posthog) {
        window.posthog.opt_out_capturing();
      }
    });
  })();
</script>
